{% extends "base.html" %}
{% block title %}{{ character.name or 'Untitled character' }} · Character Workspace{% endblock %}
{% block head_extra %}
  <style>
    .character-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .character-traits {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }
    .trait-card {
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.65);
      padding: 1.25rem;
    }
    .trait-card h2 {
      font-size: 1rem;
      margin-bottom: 0.35rem;
    }
    .trait-card p.description {
      margin-bottom: 0.75rem;
      color: rgba(226, 232, 240, 0.75);
      font-size: 0.85rem;
    }
    .trait-content {
      white-space: pre-wrap;
      color: #e2e8f0;
      min-height: 3rem;
    }
    .trait-empty {
      color: rgba(226, 232, 240, 0.5);
      font-style: italic;
    }
    .character-form {
      width: 100%;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
    }
    .form-field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .form-field textarea {
      min-height: 8rem;
    }
    .form-helper {
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.7);
      margin-top: -0.25rem;
    }
    .loading-indicator {
      display: none;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
      border-radius: 0.75rem;
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: #e2e8f0;
    }
    .loading-indicator.visible {
      display: flex;
    }
    .loading-indicator .badge {
      font-size: 0.75rem;
    }
  </style>
{% endblock %}
{% block content %}
  <div class="character-header">
    <div>
      <h1 class="h3 mb-1">{{ character.name or 'Untitled character' }}</h1>
      <p class="text-secondary mb-0">Role in story: <span id="characterRoleText">{{ character.role_in_story or 'Not specified yet.' }}</span></p>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-outline-light btn-sm">Back to project</a>
      <form method="post">
        <button type="submit" name="reset_form" value="1" class="btn btn-outline-light btn-sm">Clear form</button>
      </form>
    </div>
  </div>
  <div class="row g-4">
    <div class="col-xl-5">
      <div class="card h-100">
        <div class="card-body">
          <h2 class="h5 mb-3">Character outline</h2>
          <div class="character-traits">
            {% for field in character_fields %}
              <section
                class="trait-card"
                data-field-key="{{ field.key }}"
                data-field-label="{{ field.label }}"
              >
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <h2 class="h6 mb-0">{{ field.label }}</h2>
                  {% if field.word_count %}
                    <span class="badge bg-secondary">{{ field.word_count }} words</span>
                  {% endif %}
                </div>
                <p class="description">{{ field.description }}</p>
                {% set value = character|attr(field.key) %}
                <div
                  id="traitContent-{{ field.key }}"
                  class="trait-content {{ 'trait-empty' if not value }}"
                >
                  {{ value or 'No outline yet. Complete the form to generate one.' }}
                </div>
              </section>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-7">
      <div class="card h-100">
        <div class="card-body d-flex flex-column">
          <div class="mb-3">
            <h2 class="h5 mb-1">Character brief</h2>
            <p class="text-secondary mb-0">Provide as many details as you know. Leave fields blank to give the assistant creative freedom.</p>
          </div>
          <div id="characterMessageArea" class="mb-2"></div>
          <div id="characterLoadingIndicator" class="loading-indicator" role="status" aria-live="polite">
            <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
            <span id="characterLoadingMessage">Preparing assistant…</span>
            <span id="characterDeviceBadge" class="badge bg-secondary ms-auto"></span>
          </div>
          <form
            method="post"
            id="characterForm"
            class="character-form d-flex flex-column gap-3 flex-grow-1"
            data-generate-url="{{ url_for('character_generate', project_id=project.id, character_id=character.id) }}"
            data-device-hint="{{ device_hint }}"
          >
            <div class="form-grid">
              {% for field in input_fields %}
                <div class="form-field">
                  <label class="form-label" for="field-{{ field.key }}">
                    {{ field.label }}{% if field.required %} <span class="text-danger">*</span>{% endif %}
                  </label>
                  {% if field.description %}
                    <div class="form-helper">{{ field.description }}</div>
                  {% endif %}
                  {% if field.input_type == 'textarea' %}
                    <textarea
                      class="form-control"
                      id="field-{{ field.key }}"
                      name="{{ field.key }}"
                      rows="4"
                      {% if field.required %}required{% endif %}
                    >{{ form_data.get(field.key, '') | trim }}</textarea>
                  {% else %}
                    <input
                      type="text"
                      class="form-control"
                      id="field-{{ field.key }}"
                      name="{{ field.key }}"
                      value="{{ form_data.get(field.key, '') }}"
                      {% if field.required %}required{% endif %}
                    />
                  {% endif %}
                </div>
              {% endfor %}
            </div>
            <div class="d-flex justify-content-end gap-2 mt-auto">
              <button type="submit" class="btn btn-primary">Generate outline</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
  <script>
    (function () {
      const form = document.getElementById("characterForm");
      const loadingIndicator = document.getElementById("characterLoadingIndicator");
      const loadingMessage = document.getElementById("characterLoadingMessage");
      const deviceBadge = document.getElementById("characterDeviceBadge");
      const messageArea = document.getElementById("characterMessageArea");
      if (!form || !loadingIndicator || !loadingMessage) {
        return;
      }

      const deviceHint = form.getAttribute("data-device-hint") || "";

      const setDeviceBadge = (deviceType) => {
        if (!deviceBadge) {
          return;
        }
        const normalized = (deviceType || "").toString().toUpperCase();
        deviceBadge.textContent = normalized ? `${normalized} mode` : "";
        deviceBadge.classList.remove("bg-secondary", "bg-warning", "bg-success");
        if (!normalized) {
          deviceBadge.classList.add("bg-secondary");
          return;
        }
        if (normalized === "GPU") {
          deviceBadge.classList.add("bg-success");
        } else {
          deviceBadge.classList.add("bg-warning");
        }
      };

      const renderAlert = (type, text) => {
        if (!messageArea) {
          return;
        }
        messageArea.innerHTML = "";
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.setAttribute("role", "alert");
        alert.textContent = text;
        messageArea.appendChild(alert);
      };

      const updateOutlineSection = (sections, fallbackOutline) => {
        const updates = Array.isArray(sections) && sections.length ? sections : [
          { key: "character_outline", content: fallbackOutline }
        ];
        updates.forEach((section) => {
          if (!section || typeof section !== "object") {
            return;
          }
          const key = section.key;
          const content = typeof section.content === "string" ? section.content.trim() : "";
          if (!key) {
            return;
          }
          const selectorKey = window.CSS && typeof window.CSS.escape === "function"
            ? window.CSS.escape(key)
            : String(key).replace(/"/g, '\\"');
          const card = document.querySelector(`.trait-card[data-field-key="${selectorKey}"]`);
          if (!card) {
            return;
          }
          const contentContainer = card.querySelector(".trait-content");
          if (!contentContainer) {
            return;
          }
          contentContainer.classList.toggle("trait-empty", !content);
          contentContainer.textContent = content || "No outline yet. Complete the form to generate one.";
        });
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const submitButton = form.querySelector("button[type='submit']");
        const generateUrl = form.getAttribute("data-generate-url");
        if (!generateUrl) {
          renderAlert("danger", "Generation endpoint is not configured.");
          return;
        }

        const formData = new FormData(form);
        const payload = {};
        formData.forEach((value, key) => {
          if (typeof value === "string") {
            payload[key] = value.trim();
          } else {
            payload[key] = value;
          }
        });

        if (!payload.name) {
          renderAlert("danger", "Name is a required field.");
          return;
        }
        if (!payload.role_in_story) {
          renderAlert("danger", "Role in the story is a required field.");
          return;
        }

        renderAlert("info", "Sending your brief to the assistant.");
        loadingIndicator.classList.add("visible");
        if (deviceHint) {
          loadingMessage.textContent = `Generating character outline… (expected ${deviceHint})`;
          setDeviceBadge(deviceHint);
        } else {
          loadingMessage.textContent = "Generating character outline…";
          setDeviceBadge("");
        }

        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Generating…';
        }

        try {
          const response = await fetch(generateUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ inputs: payload }),
          });

          const data = await response.json().catch(() => null);
          if (!response.ok) {
            const errorMessage = data && data.error
              ? data.error
              : `Request failed with status ${response.status}`;
            throw new Error(errorMessage);
          }

          updateOutlineSection(Array.isArray(data.sections) ? data.sections : [], data.character_outline || "");

          if (data.character && typeof data.character === "object") {
            const nameHeading = document.querySelector(".character-header h1");
            if (nameHeading && typeof data.character.name === "string") {
              const trimmedName = data.character.name.trim();
              nameHeading.textContent = trimmedName || "Untitled character";
            }
            const roleElement = document.getElementById("characterRoleText");
            if (roleElement && typeof data.character.role_in_story === "string") {
              const trimmedRole = data.character.role_in_story.trim();
              roleElement.textContent = trimmedRole || "Not specified yet.";
            }
          }

          if (data.device_type) {
            loadingMessage.textContent = `Character outline generated using the ${data.device_type.toUpperCase()} backend.`;
            setDeviceBadge(data.device_type);
          } else {
            loadingMessage.textContent = "Character outline generated.";
            setDeviceBadge(deviceHint);
          }

          renderAlert("success", data.message || "Character outline updated from assistant.");
        } catch (err) {
          const message = err instanceof Error ? err.message : "An unexpected error occurred.";
          loadingMessage.textContent = "The assistant could not complete the request.";
          setDeviceBadge("");
          renderAlert(
            "danger",
            `The assistant could not generate the character outline. ${message}`
          );
        }

        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = "Generate outline";
        }
        loadingIndicator.classList.remove("visible");
      });
    })();
  </script>
{% endblock %}
