{% extends "base.html" %}

{% block title %}{{ project.title }} • Book Pipeline Studio{% endblock %}

{% block content %}
<div class="row g-4 align-items-start">
  <div class="col-lg-4">
    <div class="card frosted-card border-0 shadow-sm mb-4">
      <div class="card-body">
        <h2 class="h5 text-white fw-semibold mb-3">Project overview</h2>
        <p class="text-white-50 mb-1"><strong>Status:</strong> {{ project.status.replace('_', ' ').title() }}</p>
        <p class="text-white-50"><strong>Current step:</strong> {{ project.current_step.replace('_', ' ').title() }}</p>
        <p class="text-white-50">{{ project.description or "No description yet." }}</p>
      </div>
    </div>

    <div class="card frosted-card border-0 shadow-sm">
      <div class="card-body">
        <h3 class="h6 text-white text-uppercase mb-3">Pipeline steps</h3>
        <ol class="timeline vertical">
          {% for step_id, label in steps %}
          {% set step_index = loop.index0 %}
          <li class="timeline-step {% if step_index == current_index %}active{% elif step_index < current_index %}completed{% endif %}">
            <div class="step-indicator"></div>
            <div>
              <span class="step-label">{{ label }}</span>
              {% if step_index == current_index %}
              <span class="badge rounded-pill bg-primary ms-2">In progress</span>
              {% endif %}
            </div>
          </li>
          {% endfor %}
        </ol>
        <div class="d-flex gap-2 mt-4">
          <form action="{{ url_for('projects.advance', project_id=project.id) }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-primary btn-sm rounded-pill" type="submit">Advance step</button>
          </form>
          <form action="{{ url_for('projects.reset', project_id=project.id) }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-outline-light btn-sm rounded-pill" type="submit">Reset</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card frosted-card border-0 shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
          <div>
            <h2 class="h5 text-white fw-semibold mb-1">Idea → outline</h2>
            <p class="text-white-50 small mb-0">
              Transform a rough idea into a guided outline of roughly five hundred words that you can iterate on.
            </p>
          </div>
          <span class="badge rounded-pill bg-info-subtle text-info-emphasis">New</span>
        </div>
        <form method="post" class="mt-4" id="outlineForm">
          {{ outline_form.hidden_tag() }}
          <div class="mb-3">
            {{ outline_form.prompt.label(class="form-label text-white fw-semibold") }}
            {{ outline_form.prompt(class="form-control form-control-lg", rows="4", placeholder="Describe the core idea, genre, and any key characters or stakes.") }}
            {% for error in outline_form.prompt.errors %}
            <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}
            <div class="text-white-50 small mt-2">Your last prompt is saved with this project — refine or build on it anytime.</div>
          </div>
          <div class="d-flex flex-wrap align-items-center gap-3">
            {{ outline_form.submit(class="btn btn-primary rounded-pill px-4", id="generateOutlineButton") }}
            <div
              id="outlineGeneratingIndicator"
              class="d-none text-white-50 small"
              role="status"
              aria-live="polite"
            >
              <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
              <span>Generating outline…</span>
            </div>
            <span class="text-white-50 small flex-grow-1">The configured prompt template guides the LLM to deliver ~500 words.</span>
          </div>
        </form>

        {% if outline_result %}
        <div class="outline-result mt-4">
          <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
            <div>
              <h3 class="h6 text-white mb-1">Generated outline</h3>
              <p class="text-white-50 small mb-0">
                {% if outline_result.used_fallback %}
                Created with the built-in planner while the LLM connection is offline.
                {% else %}
                Created with your configured language model.
                {% endif %}
              </p>
            </div>
            <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis">
              {{ outline_result.word_count }} words
            </span>
          </div>
          <div class="outline-output" id="outlineOutput">{{ outline_result.outline }}</div>
          <div class="d-flex flex-wrap gap-2 mt-3">
            <button class="btn btn-outline-light btn-sm rounded-pill" type="button" data-copy-target="#outlineOutput">
              Copy outline
            </button>
            <button
              class="btn btn-outline-light btn-sm rounded-pill"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#outlinePrompt"
              aria-expanded="false"
              aria-controls="outlinePrompt"
            >
              View prompt
            </button>
          </div>
          <div class="collapse mt-3" id="outlinePrompt">
            <div class="prompt-preview">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-white-50 small text-uppercase">Prompt sent to the model</span>
                <button class="btn btn-light btn-sm rounded-pill" type="button" data-copy-target="#outlinePromptText">
                  Copy prompt
                </button>
              </div>
              <pre class="prompt-text" id="outlinePromptText">{{ outline_result.prompt }}</pre>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    <div class="chat-surface shadow-lg">
      <div class="chat-header d-flex justify-content-between align-items-center">
        <div>
          <h2 class="h5 text-white mb-0">Creative companion</h2>
          <small class="text-white-50">Connected to local LLM • Step: {{ project.current_step.replace('_', ' ').title() }}</small>
        </div>
        <span class="badge rounded-pill bg-success-subtle text-success-emphasis">Prototype</span>
      </div>
      <div class="chat-body">
        <div class="chat-message assistant">
          <div class="avatar">AI</div>
          <div class="bubble">
            <p class="mb-1">
              Let's focus on {{ project.current_step.replace('_', ' ').lower() }}. Provide details below and I'll craft a structured
              response.
            </p>
            <p class="mb-0 text-white-50 small">Future iterations will stream responses directly from your local model.</p>
          </div>
        </div>
        <div class="chat-message user placeholder">
          <div class="avatar">You</div>
          <div class="bubble">
            <p class="mb-0">Your conversation history will appear here once the assistant is connected.</p>
          </div>
        </div>
      </div>
      <div class="chat-input">
        <label for="message" class="form-label text-white-50">Share your guidance for this step</label>
        <textarea id="message" class="form-control" rows="4" placeholder="Describe what happens next, key beats, or stylistic goals."></textarea>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="form-check form-switch text-white-50">
            <input class="form-check-input" type="checkbox" role="switch" id="llmToggle" checked disabled />
            <label class="form-check-label" for="llmToggle">Local LLM ready</label>
          </div>
          <button class="btn btn-primary rounded-pill" type="button" disabled>Send to assistant</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (() => {
    const copyButtons = document.querySelectorAll('[data-copy-target]');
    copyButtons.forEach((button) => {
      const original = button.innerHTML;
      button.addEventListener('click', async () => {
        const selector = button.getAttribute('data-copy-target');
        const target = selector ? document.querySelector(selector) : null;
        if (!target) {
          return;
        }
        const text = target.innerText.trim();
        try {
          await navigator.clipboard.writeText(text);
          button.innerHTML = 'Copied!';
          button.classList.remove('btn-outline-light');
          button.classList.add('btn-success');
        } catch (error) {
          console.error('Copy failed', error);
          button.innerHTML = 'Copy unavailable';
          button.classList.remove('btn-outline-light');
          button.classList.add('btn-danger');
        }
        setTimeout(() => {
          button.innerHTML = original;
          button.classList.remove('btn-success', 'btn-danger');
          if (!button.classList.contains('btn-outline-light')) {
            button.classList.add('btn-outline-light');
          }
        }, 1600);
      });
    });

    const outlineForm = document.getElementById('outlineForm');
    const generateButton = document.getElementById('generateOutlineButton');
    const generatingIndicator = document.getElementById('outlineGeneratingIndicator');
    if (outlineForm && generateButton) {
      outlineForm.addEventListener('submit', () => {
        if (generateButton.hasAttribute('disabled')) {
          return;
        }
        generateButton.value = 'Generating…';
        generateButton.setAttribute('disabled', 'disabled');
        if (generatingIndicator) {
          generatingIndicator.classList.remove('d-none');
          generatingIndicator.classList.add('d-flex', 'align-items-center', 'gap-2');
        }
      });
    }
  })();
</script>
{% endblock %}
