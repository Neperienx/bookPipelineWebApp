{% extends "base.html" %}

{% block title %}{{ project.title }} • Book Pipeline Studio{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-10">
    <div class="card frosted-card border-0 shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
          <div>
            <h1 class="h4 text-white fw-semibold mb-1">{{ project.title }}</h1>
            <p class="text-white-50 mb-0">{{ project.description or "No description provided yet." }}</p>
          </div>
          <div class="text-md-end">
            <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis me-2">{{ project.status.replace('_', ' ').title() }}</span>
            <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis">Current step: {{ project.current_step.replace('_', ' ').title() }}</span>
          </div>
        </div>

        <div class="stage-status-list mb-4">
          <h2 class="h6 text-white text-uppercase mb-3">Stage status</h2>
          <ul class="list-group">
            {% for stage_id, stage_data in stage_generation_steps.items() %}
            {% set entry = stage_entries.get(stage_id) %}
            <li
              class="list-group-item d-flex justify-content-between align-items-start flex-column flex-md-row gap-3 stage-status-item"
              data-stage-status
              data-stage="{{ stage_id }}"
              data-stage-label="{{ stage_data.label | e }}"
              role="button"
              tabindex="0"
            >
              <div>
                <div class="text-white fw-semibold">{{ stage_data.label }}</div>
                <div class="small text-white-50">
                  {% if entry and entry.updated_at %}
                  Updated {{ entry.updated_at.strftime('%b %d, %Y %H:%M') }}
                  {% else %}
                  Awaiting input
                  {% endif %}
                </div>
              </div>
              <span class="badge rounded-pill {% if entry %}bg-success-subtle text-success-emphasis{% else %}bg-dark-subtle text-white-50{% endif %}">
                {% if entry %}Complete{% else %}Pending{% endif %}
              </span>
            </li>
            {% endfor %}
          </ul>
        </div>

        <div class="stage-detail-panel" id="stageDetailPanel">
          <div class="card frosted-card border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h3 class="h6 text-white mb-1" id="stageDetailLabel">Stage detail</h3>
                  <div class="text-white-50 small" id="stageDetailUpdated">Select a stage to preview its saved content.</div>
                </div>
                <span class="badge rounded-pill bg-dark-subtle text-white-50" id="stageDetailStatus">Pending</span>
              </div>
              <div class="text-warning small d-none" id="stageDetailFallback">This result used the fallback generator.</div>
              <div class="text-white-50" id="stageDetailEmpty">Pick a stage from the list to view the latest prompts and generated text.</div>
              <div class="stage-detail-content d-none" id="stageDetailContent">
                <div class="mb-3">
                  <div class="text-white-50 text-uppercase small fw-semibold mb-2">System prompt</div>
                  <div class="stage-detail-field" id="stageDetailSystem">No system prompt saved yet.</div>
                </div>
                <div class="mb-3">
                  <div class="text-white-50 text-uppercase small fw-semibold mb-2">User input</div>
                  <div class="stage-detail-field" id="stageDetailUser">No user input saved yet.</div>
                </div>
                <div>
                  <div class="text-white-50 text-uppercase small fw-semibold mb-2">Generated output</div>
                  <div class="stage-detail-field" id="stageDetailOutput">No generated output saved yet.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          id="stageWorkspace"
          data-stage-endpoint="{{ url_for('projects.generate_stage', project_id=project.id) }}"
          data-stage-config='{{ stage_client_config | tojson }}'
          data-stage-entries='{{ stage_client_entries | tojson }}'
        >
          <div class="mb-3">
            <div class="text-white-50 text-uppercase small fw-semibold mb-2">Select a stage</div>
            <div class="btn-group stage-selector" role="group" aria-label="Stage selector">
              {% for stage_id, stage_data in stage_generation_steps.items() %}
              <button
                type="button"
                class="btn btn-outline-light stage-button {% if loop.first %}active{% endif %}"
                data-stage-button
                data-stage="{{ stage_id }}"
              >
                {{ stage_data.label }}
              </button>
              {% endfor %}
            </div>
            <p class="text-white-50 small mt-3" data-stage-description>Choose a stage to load its guidance and saved progress.</p>
          </div>

          <div class="mb-3">
            <label class="form-label text-white fw-semibold" for="systemPrompt">System prompt</label>
            <textarea class="form-control" id="systemPrompt" rows="4" placeholder="Provide high-level instructions for the generator."></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label text-white fw-semibold" for="userPrompt">Your input</label>
            <textarea class="form-control" id="userPrompt" rows="5" placeholder="Describe the idea, characters, or beats you would like to explore."></textarea>
          </div>

          <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 mb-3">
            <button class="btn btn-primary rounded-pill px-4" type="button" id="generateStageButton">Generate</button>
            <div class="progress flex-grow-1 d-none" id="generationProgress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
            <div class="text-white-50 small" id="generationStatus">Select a stage to begin.</div>
          </div>

          <div class="alert alert-danger d-none" id="generationError"></div>

          <div class="mt-4">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h3 class="h6 text-white mb-0" id="outputHeading">Latest output</h3>
              <span class="badge rounded-pill bg-dark-subtle text-white-50" id="outputMeta">No generation yet</span>
            </div>
            <div class="stage-output" id="stageOutput">Run a generation to see results here.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (function () {
    const workspace = document.getElementById('stageWorkspace');
    if (!workspace) {
      return;
    }

    const endpoint = workspace.getAttribute('data-stage-endpoint');
    const config = JSON.parse(workspace.getAttribute('data-stage-config') || '{}');
    const existingEntries = JSON.parse(workspace.getAttribute('data-stage-entries') || '{}');

    const stageButtons = workspace.querySelectorAll('[data-stage-button]');
    const stageStatusItems = document.querySelectorAll('[data-stage-status]');
    const description = workspace.querySelector('[data-stage-description]');
    const systemPromptField = document.getElementById('systemPrompt');
    const userPromptField = document.getElementById('userPrompt');
    const generateButton = document.getElementById('generateStageButton');
    const progress = document.getElementById('generationProgress');
    const status = document.getElementById('generationStatus');
    const output = document.getElementById('stageOutput');
    const outputHeading = document.getElementById('outputHeading');
    const outputMeta = document.getElementById('outputMeta');
    const errorBox = document.getElementById('generationError');
    const detailPanel = document.getElementById('stageDetailPanel');
    const detailLabel = document.getElementById('stageDetailLabel');
    const detailUpdated = document.getElementById('stageDetailUpdated');
    const detailStatus = document.getElementById('stageDetailStatus');
    const detailContent = document.getElementById('stageDetailContent');
    const detailEmpty = document.getElementById('stageDetailEmpty');
    const detailSystem = document.getElementById('stageDetailSystem');
    const detailUser = document.getElementById('stageDetailUser');
    const detailOutput = document.getElementById('stageDetailOutput');
    const detailFallback = document.getElementById('stageDetailFallback');

    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

    let currentStage = stageButtons.length ? stageButtons[0].getAttribute('data-stage') : null;

    const getStageLabel = (stageId) => {
      if (!stageId) {
        return '';
      }
      const matchingItem = Array.from(stageStatusItems || []).find(
        (item) => item.getAttribute('data-stage') === stageId,
      );
      if (matchingItem) {
        return matchingItem.getAttribute('data-stage-label') || '';
      }
      const defaults = config[stageId] || {};
      return defaults.label || stageId.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
    };

    const setStatusBadge = (badge, isComplete) => {
      if (!badge) {
        return;
      }
      badge.className = `badge rounded-pill ${
        isComplete ? 'bg-success-subtle text-success-emphasis' : 'bg-dark-subtle text-white-50'
      }`;
      badge.textContent = isComplete ? 'Complete' : 'Pending';
    };

    const updateStageDetail = (stageId) => {
      if (!detailPanel || !stageId) {
        return;
      }

      const defaults = config[stageId] || {};
      const history = existingEntries[stageId] || null;

      const label = getStageLabel(stageId);
      if (detailLabel) {
        detailLabel.textContent = label || 'Stage detail';
      }

      if (detailUpdated) {
        if (history && history.updated_at) {
          detailUpdated.textContent = `Updated ${new Date(history.updated_at).toLocaleString()}`;
        } else {
          detailUpdated.textContent = history ? 'Saved result (timestamp unavailable).' : 'Awaiting input';
        }
      }

      setStatusBadge(detailStatus, Boolean(history));

      if (detailFallback) {
        if (history && history.used_fallback) {
          detailFallback.classList.remove('d-none');
        } else {
          detailFallback.classList.add('d-none');
        }
      }

      if (detailEmpty) {
        detailEmpty.classList.add('d-none');
      }
      if (detailContent) {
        detailContent.classList.remove('d-none');
      }

      const systemPrompt = (history && history.system_prompt) || defaults.system_prompt || '';
      const userPrompt = history && history.user_prompt ? history.user_prompt : '';
      const generatedText = history && history.generated_text ? history.generated_text : '';

      if (detailSystem) {
        detailSystem.textContent = systemPrompt || 'No system prompt saved yet.';
      }
      if (detailUser) {
        detailUser.textContent = userPrompt || 'No user input saved yet.';
      }
      if (detailOutput) {
        detailOutput.textContent = generatedText || 'No generated output saved yet.';
      }
    };

    const applyStageState = (stageId) => {
      const defaults = config[stageId] || {};
      const history = existingEntries[stageId] || {};

      if (description) {
        description.textContent = defaults.description || 'Provide a prompt and generate to fill this stage.';
      }

      const systemPrompt = history.system_prompt || defaults.system_prompt || '';
      systemPromptField.value = systemPrompt;
      userPromptField.value = history.user_prompt || '';

      const outputText = history.generated_text || '';
      if (outputText) {
        output.innerText = outputText;
        output.classList.add('has-content');
        outputMeta.textContent = history.updated_at ? `Updated ${new Date(history.updated_at).toLocaleString()}` : 'Saved result';
      } else {
        output.innerText = 'Run a generation to see results here.';
        output.classList.remove('has-content');
      outputMeta.textContent = 'No generation yet';
      }

      outputHeading.textContent = defaults.label ? `${defaults.label} output` : 'Latest output';
      status.textContent = 'Ready to generate.';
      if (errorBox) {
        errorBox.classList.add('d-none');
        errorBox.textContent = '';
      }
    };

    const setActiveStage = (stageId) => {
      currentStage = stageId;
      stageButtons.forEach((button) => {
        const matches = button.getAttribute('data-stage') === stageId;
        button.classList.toggle('active', matches);
      });
      if (stageStatusItems && stageStatusItems.length) {
        stageStatusItems.forEach((item) => {
          const matches = item.getAttribute('data-stage') === stageId;
          item.classList.toggle('active', matches);
          item.setAttribute('aria-pressed', matches ? 'true' : 'false');
        });
      }
      applyStageState(stageId);
      updateStageDetail(stageId);
    };

    stageButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const stageId = button.getAttribute('data-stage');
        if (!stageId) {
          return;
        }
        setActiveStage(stageId);
      });
    });

    if (stageStatusItems && stageStatusItems.length) {
      const handleStageStatusSelection = (stageId) => {
        if (!stageId) {
          return;
        }
        setActiveStage(stageId);
      };

      stageStatusItems.forEach((item) => {
        item.addEventListener('click', () => {
          handleStageStatusSelection(item.getAttribute('data-stage'));
        });
        item.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            handleStageStatusSelection(item.getAttribute('data-stage'));
          }
        });
      });
    }

    const toggleLoading = (isLoading) => {
      if (isLoading) {
        generateButton.setAttribute('disabled', 'disabled');
        generateButton.textContent = 'Generating…';
        progress.classList.remove('d-none');
        status.textContent = 'The generator is working on this stage…';
      } else {
        generateButton.removeAttribute('disabled');
        generateButton.textContent = 'Generate';
        progress.classList.add('d-none');
      }
    };

    const showError = (message) => {
      if (!errorBox) {
        return;
      }
      errorBox.textContent = message;
      errorBox.classList.remove('d-none');
    };

    const hideError = () => {
      if (!errorBox) {
        return;
      }
      errorBox.classList.add('d-none');
      errorBox.textContent = '';
    };

    generateButton.addEventListener('click', async () => {
      if (!currentStage || !endpoint) {
        return;
      }

      const userPrompt = userPromptField.value.trim();
      if (!userPrompt) {
        showError('Add a short description so the generator has something to build on.');
        userPromptField.focus();
        return;
      }

      hideError();
      toggleLoading(true);

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken || '',
            'X-CSRF-Token': csrfToken || '',
          },
          body: JSON.stringify({
            stage: currentStage,
            prompt: userPrompt,
            system_prompt: systemPromptField.value,
          }),
        });

        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || 'Unable to generate text right now.');
        }

        existingEntries[currentStage] = {
          system_prompt: payload.system_prompt || systemPromptField.value || '',
          user_prompt: userPrompt,
          generated_text: payload.content || '',
          updated_at: payload.updated_at || null,
          used_fallback: payload.used_fallback || false,
        };

        applyStageState(currentStage);
        status.textContent = payload.updated_at
          ? `Saved ${new Date(payload.updated_at).toLocaleString()}`
          : 'Draft saved.';
        updateStageDetail(currentStage);
      } catch (error) {
        const message = error instanceof Error ? error.message : 'We could not generate text at the moment.';
        showError(message);
        status.textContent = 'Generation failed. Please try again.';
      } finally {
        toggleLoading(false);
      }
    });

    if (currentStage) {
      setActiveStage(currentStage);
    } else if (stageStatusItems && stageStatusItems.length) {
      const firstStage = stageStatusItems[0].getAttribute('data-stage');
      if (firstStage) {
        updateStageDetail(firstStage);
      }
    }
  })();
</script>
{% endblock %}
